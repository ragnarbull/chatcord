<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"
        integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk="
        crossorigin="anonymous"
    />
    <link rel="stylesheet" href="css/style.css" />
    <title>SkyNet Chat</title>
</head>
<body>
    <div class="join-container">
        <header class="join-header">
            <h1><i class="fas fa-smile"></i> SkyNet</h1>
        </header>
        <main class="join-main">
            <form id="joinForm" action="chat.html">
                <div class="form-control">
                    <label for="username">Username</label>
                    <input
                        type="text"
                        name="username"
                        id="username"
                        placeholder="Enter username..."
                        required
                        pattern="[a-zA-Z0-9]{3,}"
                        title="Username must be at least 3 characters and contain only letters and numbers."
                    />
                </div>
                <div class="form-control">
                    <label for="channel">Active Channels</label>
                    <select name="channel" id="channel" onchange="toggleNewChannelInput()">
                        <!-- Add existing channels as options -->
                        <option value="" disabled selected></option>
                        <!-- Dynamically populate dropdown with existing channels from local storage -->
                        <!-- If no channels are available, the dropdown will be empty -->
                        <script>
                            var existingChannels = JSON.parse(localStorage.getItem("channels")) || [];
                            existingChannels.forEach(function (channel) {
                                document.write('<option value="' + channel + '">' + channel + '</option>');
                            });
                        </script>
                    </select>
                </div>
                <div class="form-control">
                    <label for="newChannel">New Channel</label>
                    <input
                        type="text"
                        name="newChannel"
                        id="newChannel"
                        placeholder="Enter new channel name..."
                    />
                </div>
                <button type="button" class="btn" onclick="joinChat()">Join Chat</button>
            </form>
        </main>
    </div>

    <script>
        function toggleNewChannelInput() {
            var channelDropdown = document.getElementById("channel");
            var newChannelInput = document.getElementById("newChannel");

            // Enable or disable the new channel input based on whether an existing channel is selected
            newChannelInput.disabled = channelDropdown.value !== "";
        }

        function joinChat() {
					  var form = document.getElementById("joinForm");
            var usernameInput = form.elements["username"];
            var username = usernameInput.value.trim();

            if (username.length < 3 || !/^[a-zA-Z0-9]+$/.test(username)) {
                alert("Username must be at least 3 characters and contain only letters and numbers.");
                usernameInput.focus();
                return;
            }

            var selectedChannel = form.elements["channel"].value;
            var newChannel = form.elements["newChannel"].value;

            // Determine if the user selected an existing channel or entered a new one
            var channel = selectedChannel || newChannel;

            // Save the new channel to local storage
            if (newChannel && !existingChannels.includes(newChannel)) {
                existingChannels.push(newChannel);
                localStorage.setItem("channels", JSON.stringify(existingChannels));
            }

            // Redirect to the chat.html page with the username and channel parameters
            window.location.href = "chat.html?username=" + encodeURIComponent(username) + "&channel=" + encodeURIComponent(channel);
        }
    </script>
</body>
</html>
